<!doctype html>
<html lang="zh-Hans">
<head>
    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="always">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="google-site-verification" content="m9HzlxEFMjeLY1dz5g98y0-93U1BVLaGlv_D4c984PI"/>
    <link rel="profile" href="http://gmpg.org/xfn/11"/>

    
    <title>Fulltext searching with whoosh and Jieba | 2Dosth</title>
    <meta name="description" content=""/>
    <meta name="keywords" content="jieba,whoosh,技术笔记"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Fulltext searching with whoosh and Jieba"/>
    <meta property="og:description" content=""/>


    <meta property="og:locale" content="zh-Hans">


    <link href="https://fonts.googleapis.com/css2?family=Playball&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/static/css/style.css" type="text/css">
    <link rel="stylesheet" href="/static/css/code.css" type="text/css">
    
        <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c7f70ec56346e1ef095ec0104e479a46";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


    
</head>

<body data-new-gr-c-s-check-loaded="14.991.0">

<nav>
    <div class="site-name"><a href="/">2Dosth</a></div>
    <ul class="menu">
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        

        <li><a href="https://twitter.com/OnePieceOwner" title="Twitter">
            <svg t="1664500269647" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 p-id="2003" width="20" height="20">
                <path d="M868.78260513 350.93851167c-4.19752479 316.58112364-206.64378348 533.42289687-508.84923077 547.04005471-124.62575954 5.70639316-214.91280228-34.551102-293.48715213-84.46745527 92.10982108 14.70125585 206.32520569-22.11723305 267.41045242-74.40833277-90.28704274-8.78247749-143.74276011-54.7393641-168.7552-128.69725356 26.08953618 4.51026781 53.57474644 3.31414245 78.36079771-1.93480569-81.47305755-27.27282508-139.65259487-77.62795213-142.6586621-183.14254588 22.8629151 10.40920798 46.6967339 20.19409687 78.36079772 22.12306782-60.97321937-34.68180056-106.05956011-161.46291966-54.42078633-245.29788718 90.49359316 99.18854928 199.34683533 180.12947692 378.08647293 191.07898346-44.87512251-191.83050029 209.33127293-295.85489687 315.7222473-166.92541994 44.97431338-8.70079088 81.58158405-25.7639567 116.79551453-44.33599088-14.49353846 44.54837607-42.40585299 75.68030997-76.43065983 100.58539031 37.3506188-5.04239772 70.41152364-14.16912593 98.65525243-28.12469971-17.51944388 36.39255157-55.82929687 69.02751909-88.78984388 96.50689458z"
                      fill="#2c2c2c" p-id="2004"></path>
            </svg>
        </a></li>


        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        

        <li><a href="mailto:intbleem@gmail.com" title="邮件">
            <svg t="1664500756779" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 p-id="15481" width="20" height="20">
                <path d="M853.333333 170.666667 170.666667 170.666667C123.733333 170.666667 85.333333 209.066667 85.333333 256l0 512c0 46.933333 38.4 85.333333 85.333333 85.333333l682.666667 0c46.933333 0 85.333333-38.4 85.333333-85.333333L938.666667 256C938.666667 209.066667 900.266667 170.666667 853.333333 170.666667zM853.333333 341.333333l-341.333333 213.333333L170.666667 341.333333 170.666667 256l341.333333 213.333333 341.333333-213.333333L853.333333 341.333333z"
                      p-id="15482" fill="#2c2c2c"></path>
            </svg>
        </a></li>


        
        
        
        
        
        
        
        
        

        <li><a href="/links.html" title="友情链接">
            <svg t="1664502347383" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 p-id="60354" width="20" height="20">
                <path d="M510.3 63.8c-247.4 0-448 200.6-448 448s200.6 448 448 448 448-200.6 448-448-200.5-448-448-448z m183.6 645.6c-20.5 20.5-47.3 30.7-74.2 30.7-26.9 0-53.7-10.2-74.2-30.7l-85.9-85.9c-19.8-19.8-30.7-46.1-30.7-74.2 0-11.8 2-23.2 5.7-34-1.4 2.4-3 4.8-5 6.8-12 12-31.5 12-43.4 0l-59.5-59.5c-19.8-19.8-30.7-46.1-30.7-74.2s10.9-54.4 30.7-74.2c19.8-19.8 46.1-30.7 74.2-30.7s54.4 10.9 74.2 30.7l85.9 85.9c29.2 29.2 37.5 71.6 24.9 108.3 1.4-2.5 3-4.9 5.1-6.9 11.6-11.6 31.8-11.6 43.4 0l59.5 59.5c40.9 40.9 40.9 107.5 0 148.4z"
                      p-id="60355" fill="#2c2c2c"></path>
                <path d="M591 544.9c-5.8-5.8-9-13.5-9-21.7 0-2.2 0.3-4.4 0.8-6.6-5.1 11.6-12.3 22.4-21.7 31.9-6.2 6.2-13.2 11.6-20.7 16-4.8 2.8-10.1 4.3-15.6 4.3-2.6 0-5.1-0.3-7.7-1-7.9-2-14.6-7-18.8-14.1-4.4-7.5-5.2-16.1-3.1-23.8-8.2 16.3-5.7 36.6 7.9 50.2L589 666c16.4 16.4 45.1 16.4 61.5 0 17-17 17-44.5 0-61.5L591 544.9zM503.6 455.8c8 2 14.6 7.1 18.8 14.1 4.2 7 5.4 15.3 3.3 23.3 0 0.1-0.1 0.2-0.1 0.3 8-16.3 5.4-36.4-8.1-49.9l-85.9-85.9c-17-17-44.6-17-61.5 0-17 17-17 44.6 0 61.5l59.5 59.5c5.8 5.8 9 13.5 9 21.7 0 2.2-0.3 4.3-0.7 6.4 5.2-11.6 12.4-22.4 21.7-31.6 6.2-6.2 13.1-11.6 20.7-16 7.1-4.3 15.4-5.5 23.3-3.4z"
                      p-id="60356" fill="#2c2c2c"></path>
            </svg>
        </a></li>

        
        
        
        
        
        
        

        <li><a href="/feed.xml" title="RSS订阅">
            <svg t="1664502489548" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 p-id="69131" width="20" height="20">
                <path d="M213.333333 128 810.666667 128C857.6 128 896 166.4 896 213.333333L896 810.666667C896 857.6 857.6 896 810.666667 896L213.333333 896C166.4 896 128 857.6 128 810.666667L128 213.333333C128 166.4 166.4 128 213.333333 128M320 640C284.586667 640 256 668.586667 256 704 256 739.413333 284.586667 768 320 768 355.413333 768 384 739.413333 384 704 384 668.586667 355.413333 640 320 640M256 426.666667 256 512C397.226667 512 512 626.773333 512 768L597.333333 768C597.333333 579.413333 444.586667 426.666667 256 426.666667M256 256 256 341.333333C491.52 341.333333 682.666667 532.48 682.666667 768L768 768C768 485.12 538.88 256 256 256Z"
                      p-id="69132" fill="#2c2c2c"></path>
            </svg>
        </a></li>


    </ul>
    <hr>
</nav>



<main>
    
    <div class="header-line"></div>
    <div class="article-meta">
        <h1 class="title">Fulltext searching with whoosh and Jieba</h1>

    </div>

    <div class="article-body">
        <h2>Environment dependencies</h2>
<div class="codehilite"><pre><span></span><code><span class="n">pip</span> <span class="n">install</span> <span class="n">django</span><span class="o">-</span><span class="n">haystack</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">jieba</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">whoosh</span>
</code></pre></div>


<h2>Environment configuration</h2>
<p>Add this configuration in <code>settings.py</code></p>
<div class="codehilite"><pre><span></span><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;haystack&#39;</span><span class="p">,</span> <span class="c1">#register fulltext searching framework</span>
    <span class="p">)</span>

<span class="c1">#the configuration of fulltext searching</span>
<span class="n">HAYSTACK_CONNECTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="c1"># use the whoosh search engine</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;haystack.backends.whoosh_backend.WhooshEngine&#39;</span><span class="p">,</span>
        <span class="c1"># Specifies the default path of the index files generated by the index data corresponding to the keyword. When using the custom index file, write the custom file path here.</span>
        <span class="s1">&#39;PATH&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span><span class="s1">&#39;whoosh_index&#39;</span><span class="p">),</span> <span class="c1">#  the file path of the index files.</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Auto generate indexes when add, change and delete data in database tables.</span>
<span class="n">HAYSTACK_SIGNAL_PROCESSOR</span> <span class="o">=</span> <span class="s1">&#39;haystack.signals.RealtimeSignalProcessor&#39;</span>
</code></pre></div>


<p>Create <code>search_indexs.py</code> in applications which need support searching.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">haystack</span> <span class="kn">import</span> <span class="n">indexes</span>
<span class="kn">from</span> <span class="nn">apps.blog.models</span> <span class="kn">import</span> <span class="n">Article</span>


<span class="k">class</span> <span class="nc">ArticleIndex</span><span class="p">(</span><span class="n">indexes</span><span class="o">.</span><span class="n">SearchIndex</span><span class="p">,</span> <span class="n">indexes</span><span class="o">.</span><span class="n">Indexable</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">indexes</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_template</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Article</span>

    <span class="k">def</span> <span class="nf">index_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
</code></pre></div>


<p>In the <code>templates</code> folder of the project, create folder structure like <code>search/indexes/article/article_text.txt</code>, where <code>article</code> is the lowercased model name.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Specifies which fields in the table to index</span>
<span class="p">{{</span> <span class="nb">object</span><span class="o">.</span><span class="n">title</span> <span class="p">}}</span>  <span class="c1"># index Title field</span>
<span class="p">{{</span> <span class="nb">object</span><span class="o">.</span><span class="n">body</span> <span class="p">}}</span>   <span class="c1"># index Body field</span>
</code></pre></div>


<p>Add search route</p>
<div class="codehilite"><pre><span></span><code><span class="n">path</span><span class="p">(</span><span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;haystack.urls&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;search&#39;</span><span class="p">),</span>
</code></pre></div>


<p>Add search form in the template.</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;/search&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;get&quot;</span><span class="p">&gt;</span>
            {% csrf_token %}
                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;searchAria&quot;</span> <span class="na">tabindex</span><span class="o">=</span><span class="s">&quot;0&quot;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;searching()&quot;</span> <span class="na">onblur</span><span class="o">=</span><span class="s">&quot;offsearch()&quot;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;searchInput&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;display: none; border: none;&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;q&quot;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Search&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;border: none; display: none;&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;submitInput&quot;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;javascript:void(0);&quot;</span>  <span class="na">class</span><span class="o">=</span><span class="s">&quot;navPlugs&quot;</span><span class="p">&gt;&lt;</span><span class="nt">i</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;fa fa-search&quot;</span> <span class="na">aria-hidden</span><span class="o">=</span><span class="s">&quot;true&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div>


<p>tips: there must be an input tag whose attribute named <strong>name</strong> equals <strong>q</strong> in the form.</p>
<p>The following is the page of search results.</p>
<div class="codehilite"><pre><span></span><code>    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;jupe main-body&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;post-list&quot;</span><span class="p">&gt;</span>
            {% if query and page.object_list %}
                {% for result in page.object_list %}
                    <span class="p">&lt;</span><span class="nt">li</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;post-item&quot;</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;post-title&quot;</span>
                           <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ result.object.get_absolute_url }}&quot;</span>
                           <span class="na">title</span><span class="o">=</span><span class="s">&quot;{{ result.object.title }}&quot;</span><span class="p">&gt;</span>{{ result.object.title | truncatesmart:34 }}<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;post-time&quot;</span><span class="p">&gt;</span>{{ result.object.create_time | date:&quot;Y.m.d&quot; }}<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
                    <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
                {% empty %}
                    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Not found<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
                {% endfor %}

                {% if is_paginated %}{% load_pages %}{% endif %}
            {% else %}
                <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>Found nothing. Try to search by another keyword<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
            {% endif %}

        <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div>


<p>Build index</p>
<div class="codehilite"><pre><span></span><code><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">rebuild_index</span>
</code></pre></div>


<h2>Configure Jieba Chinese Search</h2>
<p>Because the default engine of whoosh doesn't support Chinese, u need to improve it.</p>
<p>Copy the default engine file <code>\site-packages\haystack\backends\whoosh_backend.py</code> to the project folder and rename it to <code>whoosh_cn_backend</code>.</p>
<p>Open it and import Jieba Chinese analyzer <code>from jieba.analyse import ChineseAnalyzer</code>.</p>
<p>Replace <code>StemmingAnalyzer</code> in the file with <code>ChineseAnalyzer</code></p>
<p>Change the file path of search engine to custom path in <code>settings.py</code></p>
<p><code>'ENGINE': 'apps.search.whoosh_cn_backend.WhooshEngine'</code></p>
<p>Rebuild index <code>python manage.py rebuild_index</code></p>
<p>It supports Chinese search now.</p>
    </div>

    <div class="article-attrs">
        <div class="article-detail-date">
            <time>Posted on 2021-03-22</time>
        </div>

        <div class="article-category">
            <span>
                Archived in <a href="/category/Tech.html">Tech</a>
            </span>
        </div>

        <div class="article-tags">
            <ul>
                
                    <li>
                        # <a href="/tag/jieba.html">jieba</a>
                    </li>
                
                    <li>
                        # <a href="/tag/whoosh.html">whoosh</a>
                    </li>
                
                    <li>
                        # <a href="/tag/技术笔记.html">技术笔记</a>
                    </li>
                
            </ul>
        </div>

    </div>

    
    
    

</main>

<footer>
    &copy; 2020-2022 ·
    <a href="/sitemap.xml">Sitemap</a> ·
    
    
    Powered by <a href="https://github.com/Cocojcc/zogn">zogn</a>
</footer>


</body>
</html>