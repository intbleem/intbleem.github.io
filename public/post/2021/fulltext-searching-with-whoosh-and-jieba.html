<!doctype html>
<html lang="zh-Hans">
<head>
    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="always">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="profile" href="http://gmpg.org/xfn/11"/>
    <link rel="canonical" href="https://zorox.me">
    <meta property="og:locale" content="zh-Hans">

    
    <title>Fulltext searching with whoosh and Jieba | ZORO.X</title>
    <meta name="description" content=""/>
    <meta name="keywords" content="jieba,whoosh,技术笔记"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Fulltext searching with whoosh and Jieba"/>
    <meta property="og:description" content=""/>
    <meta property="og:url" content="https://zorox.me/post/2021/fulltext-searching-with-whoosh-and-jieba.html">
    <meta property="og:site_name" content="2dosth">
    <meta property="article:tag" content="jieba,whoosh,技术笔记">
    <meta property="article:category" content="技术">
    <meta property="article:published_date" content="2021-03-22">

    <link rel="canonical" href="https://zorox.me/post/2021/fulltext-searching-with-whoosh-and-jieba.html">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:description" content="">
    <meta name="twitter:title" content="Fulltext searching with whoosh and Jieba">
    <style>
        blockquote {
            padding: 0 0 0 15px;
            margin: 0 10px 0 0;
            border-left: 1px solid #615b5b;
        }

        pre {
            border: 1px solid #ccc;
            padding: 1em;
            overflow-x: auto;
            background: #f7f7f7;
        }

        p code {
            padding: 1px 4px;
            color: #d14;
            background: #faf9f9;
            border: 1px solid #ebeaea;
            border-radius: 1px;
        }

        table {
            margin: auto;
            border-top: 1px solid #666;
            border-bottom: 1px solid #666
        }

        table thead th {
            border-bottom: 1px solid #ddd
        }

        td, th {
            padding: 5px
        }

        tfoot, thead, tr:nth-child(even) {
            background: #eee
        }

    </style>
    <style>
        pre {
            line-height: 125%;
        }

        td.linenos pre {
            color: #000000;
            background-color: #f0f0f0;
            padding-left: 5px;
            padding-right: 5px;
        }

        span.linenos {
            color: #000000;
            background-color: #f0f0f0;
            padding-left: 5px;
            padding-right: 5px;
        }

        td.linenos pre.special {
            color: #000000;
            background-color: #ffffc0;
            padding-left: 5px;
            padding-right: 5px;
        }

        span.linenos.special {
            color: #000000;
            background-color: #ffffc0;
            padding-left: 5px;
            padding-right: 5px;
        }

        .codehilite .hll {
            background-color: #ffffcc
        }

        .codehilite {
            background: rgb(248, 248, 248);
        }

        .codehilite .c {
            color: #177500
        }

        /* Comment */
        .codehilite .err {
            color: #000000
        }

        /* Error */
        .codehilite .k {
            color: #A90D91
        }

        /* Keyword */
        .codehilite .l {
            color: #1C01CE
        }

        /* Literal */
        .codehilite .n {
            color: #000000
        }

        /* Name */
        .codehilite .o {
            color: #000000
        }

        /* Operator */
        .codehilite .ch {
            color: #177500
        }

        /* Comment.Hashbang */
        .codehilite .cm {
            color: #177500
        }

        /* Comment.Multiline */
        .codehilite .cp {
            color: #633820
        }

        /* Comment.Preproc */
        .codehilite .cpf {
            color: #177500
        }

        /* Comment.PreprocFile */
        .codehilite .c1 {
            color: #177500
        }

        /* Comment.Single */
        .codehilite .cs {
            color: #177500
        }

        /* Comment.Special */
        .codehilite .kc {
            color: #A90D91
        }

        /* Keyword.Constant */
        .codehilite .kd {
            color: #A90D91
        }

        /* Keyword.Declaration */
        .codehilite .kn {
            color: #A90D91
        }

        /* Keyword.Namespace */
        .codehilite .kp {
            color: #A90D91
        }

        /* Keyword.Pseudo */
        .codehilite .kr {
            color: #A90D91
        }

        /* Keyword.Reserved */
        .codehilite .kt {
            color: #A90D91
        }

        /* Keyword.Type */
        .codehilite .ld {
            color: #1C01CE
        }

        /* Literal.Date */
        .codehilite .m {
            color: #1C01CE
        }

        /* Literal.Number */
        .codehilite .s {
            color: #C41A16
        }

        /* Literal.String */
        .codehilite .na {
            color: #836C28
        }

        /* Name.Attribute */
        .codehilite .nb {
            color: #A90D91
        }

        /* Name.Builtin */
        .codehilite .nc {
            color: #3F6E75
        }

        /* Name.Class */
        .codehilite .no {
            color: #000000
        }

        /* Name.Constant */
        .codehilite .nd {
            color: #000000
        }

        /* Name.Decorator */
        .codehilite .ni {
            color: #000000
        }

        /* Name.Entity */
        .codehilite .ne {
            color: #000000
        }

        /* Name.Exception */
        .codehilite .nf {
            color: #000000
        }

        /* Name.Function */
        .codehilite .nl {
            color: #000000
        }

        /* Name.Label */
        .codehilite .nn {
            color: #000000
        }

        /* Name.Namespace */
        .codehilite .nx {
            color: #000000
        }

        /* Name.Other */
        .codehilite .py {
            color: #000000
        }

        /* Name.Property */
        .codehilite .nt {
            color: #000000
        }

        /* Name.Tag */
        .codehilite .nv {
            color: #000000
        }

        /* Name.Variable */
        .codehilite .ow {
            color: #000000
        }

        /* Operator.Word */
        .codehilite .mb {
            color: #1C01CE
        }

        /* Literal.Number.Bin */
        .codehilite .mf {
            color: #1C01CE
        }

        /* Literal.Number.Float */
        .codehilite .mh {
            color: #1C01CE
        }

        /* Literal.Number.Hex */
        .codehilite .mi {
            color: #1C01CE
        }

        /* Literal.Number.Integer */
        .codehilite .mo {
            color: #1C01CE
        }

        /* Literal.Number.Oct */
        .codehilite .sa {
            color: #C41A16
        }

        /* Literal.String.Affix */
        .codehilite .sb {
            color: #C41A16
        }

        /* Literal.String.Backtick */
        .codehilite .sc {
            color: #2300CE
        }

        /* Literal.String.Char */
        .codehilite .dl {
            color: #C41A16
        }

        /* Literal.String.Delimiter */
        .codehilite .sd {
            color: #C41A16
        }

        /* Literal.String.Doc */
        .codehilite .s2 {
            color: #C41A16
        }

        /* Literal.String.Double */
        .codehilite .se {
            color: #C41A16
        }

        /* Literal.String.Escape */
        .codehilite .sh {
            color: #C41A16
        }

        /* Literal.String.Heredoc */
        .codehilite .si {
            color: #C41A16
        }

        /* Literal.String.Interpol */
        .codehilite .sx {
            color: #C41A16
        }

        /* Literal.String.Other */
        .codehilite .sr {
            color: #C41A16
        }

        /* Literal.String.Regex */
        .codehilite .s1 {
            color: #C41A16
        }

        /* Literal.String.Single */
        .codehilite .ss {
            color: #C41A16
        }

        /* Literal.String.Symbol */
        .codehilite .bp {
            color: #5B269A
        }

        /* Name.Builtin.Pseudo */
        .codehilite .fm {
            color: #000000
        }

        /* Name.Function.Magic */
        .codehilite .vc {
            color: #000000
        }

        /* Name.Variable.Class */
        .codehilite .vg {
            color: #000000
        }

        /* Name.Variable.Global */
        .codehilite .vi {
            color: #000000
        }

        /* Name.Variable.Instance */
        .codehilite .vm {
            color: #000000
        }

        /* Name.Variable.Magic */
        .codehilite .il {
            color: #1C01CE
        }

        /* Literal.Number.Integer.Long */
    </style>


    

    <style>
        body {
            font-family: monospace;
            max-width: 650px;
            margin: 8px auto;
            padding: 0 8px;
            font-size: 1rem;
        }

        img {
            max-width: 100%;
        }
    </style>
</head>

<body>


    <a href="/">..</a>
    <br>


<main>
    
    <article class="article">
        <h1>Fulltext searching with whoosh and Jieba</h1>
        <h2>Environment dependencies</h2>
<div class="codehilite"><pre><span></span><code><span class="n">pip</span> <span class="n">install</span> <span class="n">django</span><span class="o">-</span><span class="n">haystack</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">jieba</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">whoosh</span>
</code></pre></div>


<h2>Environment configuration</h2>
<p>Add this configuration in <code>settings.py</code></p>
<div class="codehilite"><pre><span></span><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;haystack&#39;</span><span class="p">,</span> <span class="c1">#register fulltext searching framework</span>
    <span class="p">)</span>

<span class="c1">#the configuration of fulltext searching</span>
<span class="n">HAYSTACK_CONNECTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="c1"># use the whoosh search engine</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;haystack.backends.whoosh_backend.WhooshEngine&#39;</span><span class="p">,</span>
        <span class="c1"># Specifies the default path of the index files generated by the index data corresponding to the keyword. When using the custom index file, write the custom file path here.</span>
        <span class="s1">&#39;PATH&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span><span class="s1">&#39;whoosh_index&#39;</span><span class="p">),</span> <span class="c1">#  the file path of the index files.</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Auto generate indexes when add, change and delete data in database tables.</span>
<span class="n">HAYSTACK_SIGNAL_PROCESSOR</span> <span class="o">=</span> <span class="s1">&#39;haystack.signals.RealtimeSignalProcessor&#39;</span>
</code></pre></div>


<p>Create <code>search_indexs.py</code> in applications which need support searching.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">haystack</span> <span class="kn">import</span> <span class="n">indexes</span>
<span class="kn">from</span> <span class="nn">apps.blog.models</span> <span class="kn">import</span> <span class="n">Article</span>


<span class="k">class</span> <span class="nc">ArticleIndex</span><span class="p">(</span><span class="n">indexes</span><span class="o">.</span><span class="n">SearchIndex</span><span class="p">,</span> <span class="n">indexes</span><span class="o">.</span><span class="n">Indexable</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">indexes</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_template</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Article</span>

    <span class="k">def</span> <span class="nf">index_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
</code></pre></div>


<p>In the <code>templates</code> folder of the project, create folder structure like <code>search/indexes/article/article_text.txt</code>, where <code>article</code> is the lowercased model name.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Specifies which fields in the table to index</span>
<span class="p">{{</span> <span class="nb">object</span><span class="o">.</span><span class="n">title</span> <span class="p">}}</span>  <span class="c1"># index Title field</span>
<span class="p">{{</span> <span class="nb">object</span><span class="o">.</span><span class="n">body</span> <span class="p">}}</span>   <span class="c1"># index Body field</span>
</code></pre></div>


<p>Add search route</p>
<div class="codehilite"><pre><span></span><code><span class="n">path</span><span class="p">(</span><span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;haystack.urls&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;search&#39;</span><span class="p">),</span>
</code></pre></div>


<p>Add search form in the template.</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;/search&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;get&quot;</span><span class="p">&gt;</span>
            {% csrf_token %}
                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;searchAria&quot;</span> <span class="na">tabindex</span><span class="o">=</span><span class="s">&quot;0&quot;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;searching()&quot;</span> <span class="na">onblur</span><span class="o">=</span><span class="s">&quot;offsearch()&quot;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;searchInput&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;display: none; border: none;&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;q&quot;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Search&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;border: none; display: none;&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;submitInput&quot;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;javascript:void(0);&quot;</span>  <span class="na">class</span><span class="o">=</span><span class="s">&quot;navPlugs&quot;</span><span class="p">&gt;&lt;</span><span class="nt">i</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;fa fa-search&quot;</span> <span class="na">aria-hidden</span><span class="o">=</span><span class="s">&quot;true&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div>


<p>tips: there must be an input tag whose attribute named <strong>name</strong> equals <strong>q</strong> in the form.</p>
<p>The following is the page of search results.</p>
<div class="codehilite"><pre><span></span><code>    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;jupe main-body&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;post-list&quot;</span><span class="p">&gt;</span>
            {% if query and page.object_list %}
                {% for result in page.object_list %}
                    <span class="p">&lt;</span><span class="nt">li</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;post-item&quot;</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;post-title&quot;</span>
                           <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ result.object.get_absolute_url }}&quot;</span>
                           <span class="na">title</span><span class="o">=</span><span class="s">&quot;{{ result.object.title }}&quot;</span><span class="p">&gt;</span>{{ result.object.title | truncatesmart:34 }}<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;post-time&quot;</span><span class="p">&gt;</span>{{ result.object.create_time | date:&quot;Y.m.d&quot; }}<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
                    <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
                {% empty %}
                    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Not found<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
                {% endfor %}

                {% if is_paginated %}{% load_pages %}{% endif %}
            {% else %}
                <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>Found nothing. Try to search by another keyword<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
            {% endif %}

        <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div>


<p>Build index</p>
<div class="codehilite"><pre><span></span><code><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">rebuild_index</span>
</code></pre></div>


<h2>Configure Jieba Chinese Search</h2>
<p>Because the default engine of whoosh doesn't support Chinese, u need to improve it.</p>
<p>Copy the default engine file <code>\site-packages\haystack\backends\whoosh_backend.py</code> to the project folder and rename it to <code>whoosh_cn_backend</code>.</p>
<p>Open it and import Jieba Chinese analyzer <code>from jieba.analyse import ChineseAnalyzer</code>.</p>
<p>Replace <code>StemmingAnalyzer</code> in the file with <code>ChineseAnalyzer</code></p>
<p>Change the file path of search engine to custom path in <code>settings.py</code></p>
<p><code>'ENGINE': 'apps.search.whoosh_cn_backend.WhooshEngine'</code></p>
<p>Rebuild index <code>python manage.py rebuild_index</code></p>
<p>It supports Chinese search now.</p>
        <hr>
        <span>
            Date:&nbsp;2021-03-22<br>
            Category:&nbsp;<a href="/category/技术.html">技术</a><br>
            Tags:&nbsp;
            <a href="/tag/jieba.html">jieba</a>&nbsp;
        
            <a href="/tag/whoosh.html">whoosh</a>&nbsp;
        
            <a href="/tag/技术笔记.html">技术笔记</a>&nbsp;
        
        </span>
    </article>

</main>


    <footer>
    <hr>
    &copy; 2020-2022 ZOROX · CC BY-SA 4.0
</footer>




</body>
</html>