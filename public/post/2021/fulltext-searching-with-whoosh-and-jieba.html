<!doctype html>
<html lang="zh-Hans">
<head>
    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="always">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="google-site-verification" content="m9HzlxEFMjeLY1dz5g98y0-93U1BVLaGlv_D4c984PI"/>
    <link rel="profile" href="http://gmpg.org/xfn/11"/>
    <link rel="canonical" href="https://2dosth.com">
    <meta property="og:locale" content="zh-Hans">

    
    <title>Fulltext searching with whoosh and Jieba | Dosth</title>
    <meta name="description" content=""/>
    <meta name="keywords" content="T,e,c,h"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Fulltext searching with whoosh and Jieba"/>
    <meta property="og:description" content=""/>
    <meta property="og:url" content="https://2dosth.com/post/2021/fulltext-searching-with-whoosh-and-jieba.html">
    <meta property="og:site_name" content="2dosth">
    <meta property="article:tag" content="T,e,c,h">
    <meta property="article:category" content="Tech">
    <meta property="article:published_date" content="2021-03-22">

    <link rel="canonical" href="https://2dosth.com/post/2021/fulltext-searching-with-whoosh-and-jieba.html">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:description" content="">
    <meta name="twitter:title" content="Fulltext searching with whoosh and Jieba">
    <meta name="twitter:site" content="@2dosth">
    <meta name="twitter:creator" content="@2dosth">


    <link rel="stylesheet" href="/static/css/style.css" type="text/css">
    <link rel="stylesheet" href="/static/css/code.css" type="text/css">
    
        <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c7f70ec56346e1ef095ec0104e479a46";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


    
</head>

<body data-new-gr-c-s-check-loaded="14.991.0">

<nav class="header-nav">
    <a href="/" class="site-name">Dosth</a>
    <ul class="header-links">


        <li><a href="https://twitter.com/OnePieceOwner" title="Twitter">
            <svg t="1664540582595" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 p-id="13453" width="20" height="20">
                <path d="M928 254.3c-30.6 13.2-63.9 22.7-98.2 26.4 35.4-21.1 62.3-54.4 75-94-32.7 19.5-69.7 33.8-108.2 41.2C765.4 194.6 721.1 174 672 174c-94.5 0-170.5 76.6-170.5 170.6 0 13.2 1.6 26.4 4.2 39.1-141.5-7.4-267.7-75-351.6-178.5-14.8 25.4-23.2 54.4-23.2 86.1 0 59.2 30.1 111.4 76 142.1-28-1.1-54.4-9-77.1-21.7v2.1c0 82.9 58.6 151.6 136.7 167.4-14.3 3.7-29.6 5.8-44.9 5.8-11.1 0-21.6-1.1-32.2-2.6C211 652 273.9 701.1 348.8 702.7c-58.6 45.9-132 72.9-211.7 72.9-14.3 0-27.5-0.5-41.2-2.1C171.5 822 261.2 850 357.8 850 671.4 850 843 590.2 843 364.7c0-7.4 0-14.8-0.5-22.2 33.2-24.3 62.3-54.4 85.5-88.2z"
                      p-id="13454"></path>
            </svg>
        </a></li>


        
        
        
        
        
        
        
        
        
        
        
        
        


        <li><a href="mailto:intbleem@gmail.com" title="邮件">
            <svg t="1664541082447" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 p-id="29222" width="20" height="20">
                <path d="M848 192 176 192C114.112 192 64 245.696 64 312l0 400C64 778.24 114.112 832 176 832l672 0c61.888 0 112-53.76 112-120l0-400C960 245.696 909.888 192 848 192zM885.376 332.864l-0.128 0-209.152 185.6C630.848 558.656 571.52 578.752 512.064 578.752S393.152 558.656 347.904 518.464l-209.28-185.6c0 0 45.888-35.008 92.864 0l157.248 139.584c67.968 60.416 178.56 60.416 246.592 0l157.12-139.52c46.848-34.88 92.48-0.192 92.736 0L885.376 332.864 885.376 332.864z"
                      p-id="29223" fill="#2c2c2c"></path>
            </svg>
        </a></li>

















        <li><a href="/feed.xml" title="RSS订阅">
            <svg t="1664540959387" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 p-id="26382" width="20" height="20">
                <path d="M831.601 830.694c-5.591 6.057-13.046 9.318-21.433 9.318L743.54 840.012c-15.841 0-28.887-12.114-29.819-27.956-15.375-270.703-231.099-486.428-501.803-502.269-15.841-0.932-27.956-13.979-27.956-29.354l0-66.628c0-8.387 3.262-15.842 9.318-21.433 5.591-5.591 13.046-8.387 20.501-8.387 0.466 0 0.932 0 1.398 0 163.074 8.387 316.364 76.878 431.914 192.895 116.016 115.55 184.507 268.839 192.894 431.914C840.453 816.717 837.657 824.637 831.601 830.694zM593.513 830.229c-5.591 6.522-13.512 9.784-21.898 9.784l-62.901 0c-15.375 0-27.956-11.648-29.353-27.023-13.512-142.108-126.267-254.862-268.374-268.374-15.376-1.397-27.024-13.978-27.024-29.354l0-62.9c0-8.387 3.262-16.308 9.785-21.898 5.125-5.125 12.58-7.921 20.035-7.921 0.932 0 1.398 0 2.33 0 99.243 7.921 192.894 51.252 263.249 122.073 70.821 70.354 114.152 164.006 122.073 263.248C601.899 816.25 599.104 824.171 593.513 830.229zM273.42 840.013c-49.388 0-89.458-40.069-89.458-89.458s40.07-89.458 89.458-89.458 89.458 40.069 89.458 89.458S322.809 840.013 273.42 840.013z"
                      p-id="26383" fill="#2c2c2c"></path>
            </svg>
        </a></li>
    </ul>
</nav>



<main>
    
    <article class="article">
        <header class="article-header">
            <h1>Fulltext searching with whoosh and Jieba</h1>
            
                <p></p>
            

            <div class="article-list-footer">
                <span class="article-list-date">March 22, 2021</span>
                <span class="article-list-divider">-</span>
                <div class="article-list-category">
                    <a href="/category/Tech.html">Tech</a>
                </div>
                
                    <span class="article-list-divider">-</span>
                    <div class="article-list-tags">
                        
                            <a href="/tag/jieba.html">jieba</a>
                        
                            <a href="/tag/whoosh.html">whoosh</a>
                        
                            <a href="/tag/技术笔记.html">技术笔记</a>
                        
                    </div>
                
            </div>

        </header>

        <div class="article-body">
            <h2>Environment dependencies</h2>
<div class="codehilite"><pre><span></span><code><span class="n">pip</span> <span class="n">install</span> <span class="n">django</span><span class="o">-</span><span class="n">haystack</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">jieba</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">whoosh</span>
</code></pre></div>


<h2>Environment configuration</h2>
<p>Add this configuration in <code>settings.py</code></p>
<div class="codehilite"><pre><span></span><code><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;haystack&#39;</span><span class="p">,</span> <span class="c1">#register fulltext searching framework</span>
    <span class="p">)</span>

<span class="c1">#the configuration of fulltext searching</span>
<span class="n">HAYSTACK_CONNECTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="c1"># use the whoosh search engine</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;haystack.backends.whoosh_backend.WhooshEngine&#39;</span><span class="p">,</span>
        <span class="c1"># Specifies the default path of the index files generated by the index data corresponding to the keyword. When using the custom index file, write the custom file path here.</span>
        <span class="s1">&#39;PATH&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span><span class="s1">&#39;whoosh_index&#39;</span><span class="p">),</span> <span class="c1">#  the file path of the index files.</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="c1"># Auto generate indexes when add, change and delete data in database tables.</span>
<span class="n">HAYSTACK_SIGNAL_PROCESSOR</span> <span class="o">=</span> <span class="s1">&#39;haystack.signals.RealtimeSignalProcessor&#39;</span>
</code></pre></div>


<p>Create <code>search_indexs.py</code> in applications which need support searching.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">haystack</span> <span class="kn">import</span> <span class="n">indexes</span>
<span class="kn">from</span> <span class="nn">apps.blog.models</span> <span class="kn">import</span> <span class="n">Article</span>


<span class="k">class</span> <span class="nc">ArticleIndex</span><span class="p">(</span><span class="n">indexes</span><span class="o">.</span><span class="n">SearchIndex</span><span class="p">,</span> <span class="n">indexes</span><span class="o">.</span><span class="n">Indexable</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">indexes</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">document</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_template</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Article</span>

    <span class="k">def</span> <span class="nf">index_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model</span><span class="p">()</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">)</span>
</code></pre></div>


<p>In the <code>templates</code> folder of the project, create folder structure like <code>search/indexes/article/article_text.txt</code>, where <code>article</code> is the lowercased model name.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Specifies which fields in the table to index</span>
<span class="p">{{</span> <span class="nb">object</span><span class="o">.</span><span class="n">title</span> <span class="p">}}</span>  <span class="c1"># index Title field</span>
<span class="p">{{</span> <span class="nb">object</span><span class="o">.</span><span class="n">body</span> <span class="p">}}</span>   <span class="c1"># index Body field</span>
</code></pre></div>


<p>Add search route</p>
<div class="codehilite"><pre><span></span><code><span class="n">path</span><span class="p">(</span><span class="s1">&#39;search&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;haystack.urls&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;search&#39;</span><span class="p">),</span>
</code></pre></div>


<p>Add search form in the template.</p>
<div class="codehilite"><pre><span></span><code><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;/search&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;get&quot;</span><span class="p">&gt;</span>
            {% csrf_token %}
                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;searchAria&quot;</span> <span class="na">tabindex</span><span class="o">=</span><span class="s">&quot;0&quot;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&quot;searching()&quot;</span> <span class="na">onblur</span><span class="o">=</span><span class="s">&quot;offsearch()&quot;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;searchInput&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;display: none; border: none;&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;q&quot;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Search&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;border: none; display: none;&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;submitInput&quot;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;javascript:void(0);&quot;</span>  <span class="na">class</span><span class="o">=</span><span class="s">&quot;navPlugs&quot;</span><span class="p">&gt;&lt;</span><span class="nt">i</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;fa fa-search&quot;</span> <span class="na">aria-hidden</span><span class="o">=</span><span class="s">&quot;true&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div>


<p>tips: there must be an input tag whose attribute named <strong>name</strong> equals <strong>q</strong> in the form.</p>
<p>The following is the page of search results.</p>
<div class="codehilite"><pre><span></span><code>    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;jupe main-body&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;post-list&quot;</span><span class="p">&gt;</span>
            {% if query and page.object_list %}
                {% for result in page.object_list %}
                    <span class="p">&lt;</span><span class="nt">li</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;post-item&quot;</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;post-title&quot;</span>
                           <span class="na">href</span><span class="o">=</span><span class="s">&quot;{{ result.object.get_absolute_url }}&quot;</span>
                           <span class="na">title</span><span class="o">=</span><span class="s">&quot;{{ result.object.title }}&quot;</span><span class="p">&gt;</span>{{ result.object.title | truncatesmart:34 }}<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;post-time&quot;</span><span class="p">&gt;</span>{{ result.object.create_time | date:&quot;Y.m.d&quot; }}<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
                    <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
                {% empty %}
                    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Not found<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
                {% endfor %}

                {% if is_paginated %}{% load_pages %}{% endif %}
            {% else %}
                <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>Found nothing. Try to search by another keyword<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
            {% endif %}

        <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div>


<p>Build index</p>
<div class="codehilite"><pre><span></span><code><span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">rebuild_index</span>
</code></pre></div>


<h2>Configure Jieba Chinese Search</h2>
<p>Because the default engine of whoosh doesn't support Chinese, u need to improve it.</p>
<p>Copy the default engine file <code>\site-packages\haystack\backends\whoosh_backend.py</code> to the project folder and rename it to <code>whoosh_cn_backend</code>.</p>
<p>Open it and import Jieba Chinese analyzer <code>from jieba.analyse import ChineseAnalyzer</code>.</p>
<p>Replace <code>StemmingAnalyzer</code> in the file with <code>ChineseAnalyzer</code></p>
<p>Change the file path of search engine to custom path in <code>settings.py</code></p>
<p><code>'ENGINE': 'apps.search.whoosh_cn_backend.WhooshEngine'</code></p>
<p>Rebuild index <code>python manage.py rebuild_index</code></p>
<p>It supports Chinese search now.</p>
        </div>

    </article>

</main>

<footer>
    <div class="links">
        <ul>
            
                <li>
                    // <a href="http://blog.zhanghaoran.ren/">zhanghaoran.ren</a>
                </li>
            
        </ul>
    </div>
    &copy; Dosth | Theme: <a href="http://chalk.nielsenramon.com">Chalk</a>
    
    
    
    
</footer>


</body>
</html>