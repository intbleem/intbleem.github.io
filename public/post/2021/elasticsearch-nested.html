<!doctype html>
<html lang="zh-Hans">
<head>
    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="always">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="google-site-verification" content="m9HzlxEFMjeLY1dz5g98y0-93U1BVLaGlv_D4c984PI"/>
    <link rel="profile" href="http://gmpg.org/xfn/11"/>
    <link rel="canonical" href="https://2dosth.com">
    <meta property="og:locale" content="zh-Hans">

    
    <title>Elasticsearch相关汇总 | Dosth</title>
    <meta name="description" content=""/>
    <meta name="keywords" content="T,e,c,h"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Elasticsearch相关汇总"/>
    <meta property="og:description" content=""/>
    <meta property="og:url" content="https://2dosth.com/post/2021/elasticsearch-nested.html">
    <meta property="og:site_name" content="2dosth">
    <meta property="article:tag" content="T,e,c,h">
    <meta property="article:category" content="Tech">
    <meta property="article:published_date" content="2021-12-04">

    <link rel="canonical" href="https://2dosth.com/post/2021/elasticsearch-nested.html">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:description" content="">
    <meta name="twitter:title" content="Elasticsearch相关汇总">
    <meta name="twitter:site" content="@2dosth">
    <meta name="twitter:creator" content="@2dosth">


    <link rel="stylesheet" href="/static/css/style.css" type="text/css">
    <link rel="stylesheet" href="/static/css/code.css" type="text/css">
    
        <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c7f70ec56346e1ef095ec0104e479a46";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


    
</head>

<body data-new-gr-c-s-check-loaded="14.991.0">

<nav class="header-nav">
    <a href="/" class="site-name">Dosth</a>
    <ul class="header-links">


        <li><a href="https://twitter.com/OnePieceOwner" title="Twitter">
            <svg t="1664540582595" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 p-id="13453" width="20" height="20">
                <path d="M928 254.3c-30.6 13.2-63.9 22.7-98.2 26.4 35.4-21.1 62.3-54.4 75-94-32.7 19.5-69.7 33.8-108.2 41.2C765.4 194.6 721.1 174 672 174c-94.5 0-170.5 76.6-170.5 170.6 0 13.2 1.6 26.4 4.2 39.1-141.5-7.4-267.7-75-351.6-178.5-14.8 25.4-23.2 54.4-23.2 86.1 0 59.2 30.1 111.4 76 142.1-28-1.1-54.4-9-77.1-21.7v2.1c0 82.9 58.6 151.6 136.7 167.4-14.3 3.7-29.6 5.8-44.9 5.8-11.1 0-21.6-1.1-32.2-2.6C211 652 273.9 701.1 348.8 702.7c-58.6 45.9-132 72.9-211.7 72.9-14.3 0-27.5-0.5-41.2-2.1C171.5 822 261.2 850 357.8 850 671.4 850 843 590.2 843 364.7c0-7.4 0-14.8-0.5-22.2 33.2-24.3 62.3-54.4 85.5-88.2z"
                      p-id="13454"></path>
            </svg>
        </a></li>


        
        
        
        
        
        
        
        
        
        
        
        
        


        <li><a href="mailto:intbleem@gmail.com" title="邮件">
            <svg t="1664541082447" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 p-id="29222" width="20" height="20">
                <path d="M848 192 176 192C114.112 192 64 245.696 64 312l0 400C64 778.24 114.112 832 176 832l672 0c61.888 0 112-53.76 112-120l0-400C960 245.696 909.888 192 848 192zM885.376 332.864l-0.128 0-209.152 185.6C630.848 558.656 571.52 578.752 512.064 578.752S393.152 558.656 347.904 518.464l-209.28-185.6c0 0 45.888-35.008 92.864 0l157.248 139.584c67.968 60.416 178.56 60.416 246.592 0l157.12-139.52c46.848-34.88 92.48-0.192 92.736 0L885.376 332.864 885.376 332.864z"
                      p-id="29223" fill="#2c2c2c"></path>
            </svg>
        </a></li>

















        <li><a href="/feed.xml" title="RSS订阅">
            <svg t="1664540959387" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 p-id="26382" width="20" height="20">
                <path d="M831.601 830.694c-5.591 6.057-13.046 9.318-21.433 9.318L743.54 840.012c-15.841 0-28.887-12.114-29.819-27.956-15.375-270.703-231.099-486.428-501.803-502.269-15.841-0.932-27.956-13.979-27.956-29.354l0-66.628c0-8.387 3.262-15.842 9.318-21.433 5.591-5.591 13.046-8.387 20.501-8.387 0.466 0 0.932 0 1.398 0 163.074 8.387 316.364 76.878 431.914 192.895 116.016 115.55 184.507 268.839 192.894 431.914C840.453 816.717 837.657 824.637 831.601 830.694zM593.513 830.229c-5.591 6.522-13.512 9.784-21.898 9.784l-62.901 0c-15.375 0-27.956-11.648-29.353-27.023-13.512-142.108-126.267-254.862-268.374-268.374-15.376-1.397-27.024-13.978-27.024-29.354l0-62.9c0-8.387 3.262-16.308 9.785-21.898 5.125-5.125 12.58-7.921 20.035-7.921 0.932 0 1.398 0 2.33 0 99.243 7.921 192.894 51.252 263.249 122.073 70.821 70.354 114.152 164.006 122.073 263.248C601.899 816.25 599.104 824.171 593.513 830.229zM273.42 840.013c-49.388 0-89.458-40.069-89.458-89.458s40.07-89.458 89.458-89.458 89.458 40.069 89.458 89.458S322.809 840.013 273.42 840.013z"
                      p-id="26383" fill="#2c2c2c"></path>
            </svg>
        </a></li>
    </ul>
</nav>



<main>
    
    <article class="article">
        <header class="article-header">
            <h1>Elasticsearch相关汇总</h1>
            
                <p></p>
            

            <div class="article-list-footer">
                <span class="article-list-date">December 04, 2021</span>
                <span class="article-list-divider">-</span>
                <div class="article-list-category">
                    <a href="/category/Tech.html">Tech</a>
                </div>
                
                    <span class="article-list-divider">-</span>
                    <div class="article-list-tags">
                        
                            <a href="/tag/Elasticsearch.html">Elasticsearch</a>
                        
                            <a href="/tag/技术笔记.html">技术笔记</a>
                        
                    </div>
                
            </div>

        </header>

        <div class="article-body">
            <p>在使用Elasticsearch的过程中，难免会要去官网翻看文档，由于目前还没有读完文档，以至于在找一些没用过的API时还挺费劲，有时候甚至还可能找不到。因此就把目前已经用到过的地方在这里汇总记录一下，方便以后碰到的话可以直接去查看。</p>
<h2>Index</h2>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/indices.html#index-management">https://www.elastic.co/guide/en/elasticsearch/reference/7.16/indices.html#index-management</a></li>
</ul>
<h2>Aliases</h2>
<p>索引的一个别名，在某些情况下非常有用，比如在无缝切换索引的时候。</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/aliases.html#aliases">https://www.elastic.co/guide/en/elasticsearch/reference/7.16/aliases.html#aliases</a></li>
</ul>
<h2>Mappings</h2>
<p>索引的mapping定义十分重要，他决定了我们的数据是如何保存在索引内，以及保存的数据都有什么字段，各个字段的数据类型又是什么。</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/mapping.html#mapping">https://www.elastic.co/guide/en/elasticsearch/reference/7.16/mapping.html#mapping</a></li>
</ul>
<h2>Setting</h2>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/index-modules.html#index-modules-settings">https://www.elastic.co/guide/en/elasticsearch/reference/7.16/index-modules.html#index-modules-settings</a></li>
</ul>
<h2>Query</h2>
<h3>Full text queries</h3>
<p>全文检索相关，主要包含<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-match-query.html">match query</a>、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-match-bool-prefix-query.html">match_bool_prefix query</a>、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-match-query-phrase.html">match_phrase query</a>、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-match-query-phrase-prefix.html">match_phrase_prefix query</a>、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-multi-match-query.html">multi_match query</a>、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-query-string-query.html">query_string query</a>、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-match-bool-prefix-query.html">match_bool_prefix query</a>、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-match-query-phrase.html">match_phrase query</a>、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-match-query-phrase-prefix.html">match_phrase_prefix query</a>、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-multi-match-query.html">multi_match query</a>、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-query-string-query.html">query_string query</a>等</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/full-text-queries.html#full-text-queries">https://www.elastic.co/guide/en/elasticsearch/reference/7.16/full-text-queries.html#full-text-queries</a></li>
</ul>
<h3>Compound queries</h3>
<p>混合索引，包含<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-bool-query.html">bool query</a>、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-boosting-query.html">boosting query</a>、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-constant-score-query.html">constant_score query</a>、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-dis-max-query.html">dis_max query</a>、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-function-score-query.html">function_score query</a></p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/compound-queries.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.16/compound-queries.html</a></li>
</ul>
<h3>Function score query</h3>
<p>用户可以通过自定义一个或多个查询语句来提高某些文档的比分权重，</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-function-score-query.html#query-dsl-function-score-query">https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-function-score-query.html#query-dsl-function-score-query</a></li>
</ul>
<p>还可以通过<strong>script_score</strong>使用脚本给每个文档重新打分</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-function-score-query.html#function-script-score">https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-function-score-query.html#function-script-score</a></li>
</ul>
<h3>Highlight</h3>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/highlighting.html#highlighting">https://www.elastic.co/guide/en/elasticsearch/reference/7.16/highlighting.html#highlighting</a></li>
</ul>
<h3>Prefix query</h3>
<p>使用前缀查询可以返回前缀为指定前缀的文档，多用于即时搜索一类的提示。</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-prefix-query.html#query-dsl-prefix-query">https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-prefix-query.html#query-dsl-prefix-query</a></li>
</ul>
<h3>Match phrase prefix query</h3>
<p>当需要对一个短语或词组进行前缀查询时，就需要用到来进行搜索了</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-match-query-phrase-prefix.html#query-dsl-match-query-phrase-prefix">https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-match-query-phrase-prefix.html#query-dsl-match-query-phrase-prefix</a></li>
</ul>
<h3>Named query</h3>
<p>通过使用<code>_name</code>参数可以在多字段查询时知道是哪个子查询语句命中了该文档，并将结果返回在每个响应文档的<code>matched_queries</code>字段内。</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-bool-query.html#named-queries">https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-bool-query.html#named-queries</a></li>
</ul>
<h3>Nested query</h3>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-nested-query.html#query-dsl-nested-query">https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-nested-query.html#query-dsl-nested-query</a></li>
</ul>
<h3>Exists query</h3>
<p>在某些情况下，并不是所有的字段都存在确切的值，可以通过<strong>Exists</strong>来或者筛选包含某些字段的文档，同时配合<strong>must_not</strong>可以来筛选所有存在该字段的文档。</p>
<ul>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-exists-query.html#query-dsl-exists-query">https://www.elastic.co/guide/en/elasticsearch/reference/7.16/query-dsl-exists-query.html#query-dsl-exists-query</a></li>
</ul>
<h2>Scripts</h2>
<p>ES的脚本语言是<code>painless</code>，语法与Java类似，可直接按照Java的语法来编写检索脚本，具体可见地址：<a href="https://www.elastic.co/guide/en/elasticsearch/painless/7.16/painless-api-reference-shared.html">Shard API </a>。</p>
<p>这里只记录一下自己使用到的，以便以后再遇到可直接CV。</p>
<h3>删除数组内满足条件的元素</h3>
<p>使用<strong>removeIf</strong>来完成，例如删除ID为10的元素</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;script&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;ctx._source.members.removeIf(list_item -&gt; list_item.id == params.member_id)&quot;</span><span class="p">,</span>
    <span class="nt">&quot;lang&quot;</span><span class="p">:</span> <span class="s2">&quot;painless&quot;</span><span class="p">,</span>
    <span class="nt">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;member_id&quot;</span><span class="p">:</span> <span class="mi">10</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<h3>判断数组内是否包含某一个对象</h3>
<p>使用<strong>contains</strong>来完成，返回包含<code>name</code>为<strong>张三</strong>的文档</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;script&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;ctx._source.members.contains(params.name)&quot;</span><span class="p">,</span>
    <span class="nt">&quot;lang&quot;</span><span class="p">:</span> <span class="s2">&quot;painless&quot;</span><span class="p">,</span>
    <span class="nt">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;张三&quot;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<h3>根据时间提高某些文档的权重</h3>
<p>使用时间格式化方法<strong>toInstant</strong>和<strong>toEpochMilli</strong>来完成，将时间转换成毫秒级权重因子</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;script&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;lang&quot;</span><span class="p">:</span> <span class="s2">&quot;painless&quot;</span><span class="p">,</span> 
        <span class="nt">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;double dateScore; try {dateScore = Math.abs(doc[&#39;enforcementDate&#39;].value.toInstant().toEpochMilli()/1e12);} catch (Exception e) {dateScore=0;} return dateScore;&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
        </div>

    </article>

</main>

<footer>
    <div class="links">
        <ul>
            
                <li>
                    // <a href="http://blog.zhanghaoran.ren/">zhanghaoran.ren</a>
                </li>
            
        </ul>
    </div>
    &copy; Dosth | Theme: <a href="http://chalk.nielsenramon.com">Chalk</a>
    
    
    
    
</footer>


</body>
</html>