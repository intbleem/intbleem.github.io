<!doctype html>
<html lang="zh-Hans">
<head>
    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="always">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="google-site-verification" content="m9HzlxEFMjeLY1dz5g98y0-93U1BVLaGlv_D4c984PI"/>
    <link rel="profile" href="http://gmpg.org/xfn/11"/>

    
    <title>bulk_create内存异常排查 | 2Dosth</title>
    <meta name="description" content=""/>
    <meta name="keywords" content="django,MySQLdb"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="bulk_create内存异常排查"/>
    <meta property="og:description" content=""/>


    <meta property="og:locale" content="zh-Hans">

    <link href="https://fonts.googleapis.com/css2?family=Arvo&family=Playball&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/static/css/style.css" type="text/css">
    <link rel="stylesheet" href="/static/css/code.css" type="text/css">
    
        <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c7f70ec56346e1ef095ec0104e479a46";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


    
</head>

<body data-new-gr-c-s-check-loaded="14.991.0">

<nav>
    <div class="site-name"><a href="/">2Dosth</a></div>
    <ul class="menu">
        
        
        
        
        
        
        


        <li><a href="/links.html" title="友情链接">
            <svg t="1664161702390" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="8985"
                 width="20" height="20">
                <path d="M339.57 697c1 0.86 1.79 1 1.16 0.46a21.38 21.38 0 0 0-2-1.18c0.27 0.27 0.56 0.52 0.84 0.72zM428.33 696.49c-0.5 0.34-1 0.75-1.45 1.13a5.06 5.06 0 0 0 0.81-0.58zM393.21 711.57c3-0.3 1.54-0.23-0.07 0h-0.28zM392.86 711.6h-0.07c-0.43 0.06-0.86 0.14-1.2 0.22 0.41-0.09 0.84-0.16 1.27-0.22zM338.73 696.32l-0.06-0.06-0.56-0.28zM317.65 668.51c0.42 1.14 1.06 1.81 0.82 1.11-0.39-0.8-0.82-1.58-1.27-2.34zM542.41 582.32a3.85 3.85 0 0 0 0.76-1.21 18.8 18.8 0 0 0-1.45 2zM552.76 564.32l-0.35 0.57a2 2 0 0 0-0.08 0.22c0.14-0.27 0.28-0.54 0.43-0.79zM429.15 696l-0.58 0.29-0.24 0.22a5.54 5.54 0 0 1 0.82-0.51zM556.72 526.64v0.94c0 0.29 0.12 0.6 0.17 0.91a15 15 0 0 1-0.17-1.85zM557 528.94l-0.09-0.45c0.05 0.3 0.09 0.59 0.11 0.88s0 0.64 0.08 1a6.14 6.14 0 0 0-0.1-1.43zM541.72 583.12l-0.08 0.09c-0.09 0.18-0.19 0.37-0.28 0.57a7.16 7.16 0 0 1 0.36-0.66zM317.2 667.28v-0.07l-0.36-0.57z"
                      p-id="8986"></path>
                <path d="M552.33 565.11c-0.42 0.77-0.8 1.59-1.16 2.43a3.83 3.83 0 0 0 0.76-1.35c0.13-0.36 0.26-0.72 0.4-1.08zM312.69 630.75c0.05-0.3 0.11-0.6 0.16-0.89s0-0.58 0-0.9a14 14 0 0 1-0.16 1.79zM375.67 711.83l-0.38-0.08zM597.65 326.45l-1 0.71c-2.73 1.92-0.1 0.16 1-0.71zM374.05 711.57h0.42c-1.73-0.22-3.61-0.32-0.42 0zM706.72 411.9l0.55-1.14a3.69 3.69 0 0 0 0.39-1.19c0 0.16-0.11 0.32-0.17 0.48-0.18 0.5-0.49 1.2-0.77 1.85zM706.72 411.9l-0.13 0.26c0 0.16-0.06 0.31-0.09 0.48a4.3 4.3 0 0 1 0.22-0.74z"
                      p-id="8987"></path>
                <path d="M512 65C265.13 65 65 265.13 65 512s200.13 447 447 447 447-200.13 447-447S758.87 65 512 65z m91.65 492.62c-3.82 26.66-17.91 49.76-36.69 68.54l-83.15 83.15C472.15 721 461 733 446.92 741.88c-32.36 20.59-74.27 23.52-109.41 8.68S275 704.24 267.1 666.7c-8.17-38.92 2.64-79.4 30-108.46 21.52-22.83 44.42-44.48 66.6-66.66 9.48-9.48 24.35-8.79 33.92 0s8.88 25 0 33.91l-2.53 2.51L356 567.12l-18.34 18.33c-1.41 1.41-2.83 2.82-4.23 4.24-1.16 1.16-2.3 2.33-3.41 3.54s-2.22 2.87-3.47 4.09l-0.45 0.63a92.07 92.07 0 0 0-6.27 10.27c-0.72 1.36-1.37 2.74-2 4.13-0.21 0.54-0.45 1.08-0.65 1.6a96.77 96.77 0 0 0-3.51 11.91c-0.3 1.33-0.55 2.66-0.8 4-0.06 3.35-0.31 3.57-0.36 2.8a97.31 97.31 0 0 0-0.29 10.66c0 1.6 0.13 3.19 0.25 4.79l0.12 1.25c0.88 3.74 1.38 7.56 2.44 11.28 0.51 1.77 1.08 3.53 1.69 5.27 0.15 0.43 0.31 0.87 0.48 1.3a14 14 0 0 1 1.29 2.41c1.27 2.53 2.35 5.22 3.79 7.62 1 1.63 2 3.23 3.05 4.79 0.46 0.68 4.1 6.28 1.93 2.78-2-3.29 0.24 0.21 0.87 0.94s1.28 1.46 1.93 2.18q1.48 1.64 3 3.19c1.39 1.38 2.81 2.72 4.28 4l1.3 1.12a11.4 11.4 0 0 1 2.06 1.24c2.51 1.65 4.92 3.71 7.46 5.17 1.62 0.93 3.27 1.82 4.95 2.65 0.27 0.14 1.27 0.61 2.22 1.06 0.6 0.25 1.32 0.55 1.64 0.67 0.87 0.31 1.74 0.62 2.61 0.91 1.75 0.59 3.52 1.12 5.29 1.61 3.26 0.88 6.6 1.31 9.87 2.06 0.67 0.07 1.34 0.13 2 0.18 1.82 0.13 3.64 0.2 5.47 0.23a97.37 97.37 0 0 0 10.53-0.43l0.35-0.05c0.4-0.06 0.79-0.11 1.16-0.18q2.71-0.48 5.39-1.13a95.25 95.25 0 0 0 10.57-3.2l0.61-0.25c3.89-2 1.62-0.71 0 0l-1.18 0.59c0.62-0.31 1.28-0.56 1.91-0.86q2.55-1.17 5-2.5a94.64 94.64 0 0 0 9.65-5.94c0.2-0.14 0.41-0.31 0.62-0.47-0.91 0.51-1 0 1.69-1.35 1.18-1 2.35-2 3.49-3.1 0.79-0.75 1.56-1.51 2.34-2.28 8.67-8.58 17.25-17.26 25.88-25.88q37.55-37.54 75.08-75.08c1.42-1.42 2.83-2.84 4.18-4.32q1.07-1.18 2.1-2.4c1.13-2.23 1.66-2.56 1.53-2.1 0.53-0.67 1.07-1.33 1.51-2a93.61 93.61 0 0 0 5.38-9.12c0.4-0.78 0.75-1.62 1.11-2.46-0.27 0.24-0.15-0.41 1.24-2.65l0.48-1.31a95 95 0 0 0 3-10.6c0.43-1.92 0.67-3.9 1.07-5.82 0-0.45 0.09-0.91 0.13-1.37a95.38 95.38 0 0 0 0.23-11c-0.05-1.5-0.15-3-0.27-4.49 0 0.77-0.3 0.57-0.36-2.76-0.6-3.16-1.27-6.29-2.16-9.38-0.64-2.21-1.36-4.41-2.15-6.57-0.18-0.49-0.41-1-0.61-1.51C550.3 507 548.75 504 547 501c-1.1-1.83-2.27-3.61-3.49-5.36-0.26-0.37-0.53-0.73-0.8-1.09-2-2.31-4-4.64-6.18-6.82-2-2-4.14-3.88-6.28-5.75a6.14 6.14 0 0 1-0.51-0.51c-0.48-0.31-1-0.6-1.29-0.83a99 99 0 0 0-11.28-6.77c-11.89-6.18-14.43-21.79-8.61-32.81 6.26-11.84 21.69-14.39 32.81-8.61a122 122 0 0 1 26.61 19c29.2 27.22 41.26 67.16 35.67 106.17z m143.22-118.87c-9.37 18.46-24.65 32.38-39.06 46.8l-32.92 32.91c-9.47 9.48-24.34 8.79-33.91 0s-8.88-25 0-33.91l2.66-2.66 37.82-37.82c3.36-3.37 6.75-6.72 10.1-10.1 1.38-1.4 2.73-2.82 4-4.29 0.47-0.53 2-2.44 2.46-3 0.58-0.81 1.15-1.6 1.3-1.83q1.39-2.06 2.69-4.18c1.68-2.77 3.13-5.63 4.55-8.53 0.53-2.82 1.14-3.28 1.07-2.59 0.49-1.36 1-2.73 1.39-4.11a93.74 93.74 0 0 0 2.65-10.69c0.07-0.35 0.13-0.69 0.19-1 0.13-1.38 0.32-2.77 0.41-4.15a95.23 95.23 0 0 0 0.08-10.95c-0.08-1.59-0.2-3.18-0.36-4.76-0.65-3.54-1.38-7-2.38-10.51q-0.76-2.66-1.68-5.27c-0.16-0.45-0.62-1.63-1-2.53-0.56-1.21-1.31-2.81-1.53-3.26-0.74-1.46-1.53-2.9-2.35-4.33-1.66-2.89-3.53-5.64-5.44-8.37l-1.12-1.35q-1.9-2.22-3.95-4.32a95 95 0 0 0-7-6.5l-0.24-0.2c-3.32-2.26-1.21-1 0 0l1.15 0.79c-0.59-0.4-1.15-0.86-1.73-1.28q-2.31-1.68-4.72-3.21a92.24 92.24 0 0 0-9.21-5.16l-1-0.5A49.63 49.63 0 0 1 665 316a90.23 90.23 0 0 0-9.3-2.6c-1.73-0.39-3.48-0.68-5.23-1l-0.59-0.07a95 95 0 0 0-10.26-0.4q-3.09 0-6.16 0.28l-1.48 0.15c-1 0.15-2.53 0.39-3 0.48-1.8 0.35-3.59 0.76-5.37 1.21a110 110 0 0 0-10.48 3.34l-0.09 0.05q-2.22 1-4.4 2.16a94.3 94.3 0 0 0-9.64 5.9c-0.34 0.23-0.66 0.46-1 0.7-0.58 1.08-2.86 2.32-3.78 3.15-1.59 1.42-3.11 2.92-4.63 4.43q-13.1 13.05-26.15 26.15l-72.61 72.61-2.43 2.46c-0.77 0.78-1.54 1.55-2.28 2.35-1.34 1.42-2.6 2.89-3.87 4.36l-0.2 0.23a95.52 95.52 0 0 0-6.09 9.57 90.25 90.25 0 0 0-2.28 4.36c-0.17 0.34-0.33 0.69-0.49 1-0.54 3.28-2.57 6.89-3.44 10.1s-1.41 6.25-2 9.4c0 0.37-0.07 0.75-0.1 1.12a90.66 90.66 0 0 0-0.31 5.47 95.11 95.11 0 0 0 0.25 10.27c0 0.38 0.07 0.76 0.11 1.14 0.37 1.51 0.48 3.2 0.79 4.7a93.43 93.43 0 0 0 2.46 9.33c0.56 1.76 1.23 3.47 1.85 5.2 0.1 0.24 0.2 0.48 0.31 0.7a94.37 94.37 0 0 0 5 9.28c1.12 1.81 2.29 3.59 3.53 5.33l0.33 0.45c2.05 2.33 4 4.68 6.24 6.88 9.48 9.48 8.79 24.34 0 33.92s-25 8.88-33.92 0a126.55 126.55 0 0 1-16.47-20.58C419 520.48 414 481.9 425.07 449c7.09-21.1 19.61-38.11 35.15-53.65l79.83-79.84c9.93-9.92 19.46-19.92 30.68-28.44 28-21.28 65.87-27.8 99.77-19.38 33.68 8.37 64.31 33 78.47 64.85 15.28 34.35 15.03 72.46-2.1 106.21z"
                      p-id="8988"></path>
                <path d="M328.07 595.22c0.16-0.23 0.2-0.27 0 0zM312.69 630.75c0 0.17-0.07 0.34-0.1 0.51a6.17 6.17 0 0 0-0.1 1.4c0-0.32 0.05-0.65 0.08-1s0.07-0.59 0.12-0.91z"
                      p-id="8989"></path>
            </svg>
        </a></li>

        <li><a href="mailto:intbleem@gmail.com" title="邮件">
            <svg t="1664164974344" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 p-id="5446" width="20" height="20">
                <path d="M869.065302 152.648632l-715.495694 0c-49.195445 0-89.436962 40.532135-89.436962 90.085738l0 540.501124c0 49.548486 40.241516 90.085738 89.436962 90.085738l715.495694 0c49.196469 0 89.436962-40.537252 89.436962-90.085738L958.502263 242.73437C958.502263 193.180767 918.260747 152.648632 869.065302 152.648632L869.065302 152.648632 869.065302 152.648632zM869.065302 332.819085l-357.747847 225.208205-357.747847-225.208205 0-90.085738 357.747847 225.208205 357.747847-225.208205L869.065302 332.819085 869.065302 332.819085 869.065302 332.819085zM869.065302 332.819085"
                      p-id="5447" fill="#2c2c2c"></path>
            </svg>
        </a></li>

        <li><a href="/tags.html" title="标签">
            <svg t="1664165544852" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 p-id="31034" width="20" height="20">
                <path d="M870.4 448a64 64 0 0 0 0-128h-114.56l26.88-148.48a64 64 0 0 0-126.08-23.04l-32 171.52h-156.8l26.88-148.48a64 64 0 0 0-126.08-23.04l-32 171.52H198.4a64 64 0 1 0 0 128h116.16l-23.36 128H153.6a64 64 0 0 0 0 128h114.56l-26.88 148.48a64 64 0 1 0 126.08 23.04l32-171.52h157.76l-26.88 148.48a64 64 0 1 0 126.08 23.04l32-171.52h137.28a64 64 0 1 0 0-128h-116.16l23.36-128z m-291.2 128h-157.76l23.36-128h157.76z"
                      fill="#2c2c2c" p-id="31035"></path>
            </svg>
        </a>
        </li>

        <li><a href="/rss.xml" title="RSS">
            <svg t="1664199466617" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 p-id="2713" width="20" height="20">
                <path d="M831.601 830.694c-5.591 6.057-13.046 9.318-21.433 9.318L743.54 840.012c-15.841 0-28.887-12.114-29.819-27.956-15.375-270.703-231.099-486.428-501.803-502.269-15.841-0.932-27.956-13.979-27.956-29.354l0-66.628c0-8.387 3.262-15.842 9.318-21.433 5.591-5.591 13.046-8.387 20.501-8.387 0.466 0 0.932 0 1.398 0 163.074 8.387 316.364 76.878 431.914 192.895 116.016 115.55 184.507 268.839 192.894 431.914C840.453 816.717 837.657 824.637 831.601 830.694zM593.513 830.229c-5.591 6.522-13.512 9.784-21.898 9.784l-62.901 0c-15.375 0-27.956-11.648-29.353-27.023-13.512-142.108-126.267-254.862-268.374-268.374-15.376-1.397-27.024-13.978-27.024-29.354l0-62.9c0-8.387 3.262-16.308 9.785-21.898 5.125-5.125 12.58-7.921 20.035-7.921 0.932 0 1.398 0 2.33 0 99.243 7.921 192.894 51.252 263.249 122.073 70.821 70.354 114.152 164.006 122.073 263.248C601.899 816.25 599.104 824.171 593.513 830.229zM273.42 840.013c-49.388 0-89.458-40.069-89.458-89.458s40.07-89.458 89.458-89.458 89.458 40.069 89.458 89.458S322.809 840.013 273.42 840.013z"
                      p-id="2714" fill="#2c2c2c"></path>
            </svg>
        </a></li>

    </ul>
    <hr>
</nav>



<main>
    
    <div class="header-line"></div>
    <div class="article-meta">
        <h1 class="title">bulk_create内存异常排查</h1>
        <div class="article-attrs">

            <span class="date"><time>Dec 14, 2021</time></span>

            <div class="article-tags">
                <ul>
                    
                        <li>
                            <a href="/tag/django.html"># django</a>
                        </li>
                    
                        <li>
                            <a href="/tag/MySQLdb.html"># MySQLdb</a>
                        </li>
                    
                </ul>
            </div>

        </div>
    </div>

    <div class="article-body">
        <p><strong>背景</strong></p>
<p>因为需要往项目数据库上传大量数据，数据是以文件的方式存储，所以采用django的<strong>bulk_create</strong>批量读取并上传，但是在上传过程中发现，上传程序占用的内存一直在上升，甚至到最后直接把内存占满了。</p>
<p><strong>排查问题</strong></p>
<p>刚开始首先怀疑的就是程序代码有问题导致内存没有释放，自己看没发现什么问题，请教同事帮忙看也没有发现什么问题，所以干脆就硬着头皮去试代码。在每次循环之后都加入<code>gc.collect()</code>,尝试主动释放内存，发现问题仍然存在。</p>
<p>于是开始尝试内存排查工具<strong>tracemalloc</strong>来排查什么地方一直在增加内存</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">batch_insert</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="n">tracemalloc</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">start_snapshot</span><span class="o">=</span><span class="n">tracemalloc</span><span class="o">.</span><span class="n">take_snapshot</span><span class="p">()</span>  <span class="c1"># 建立快照</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;**/*.json&#39;</span><span class="p">)),</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">p</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="o">...</span> <span class="c1"># 内容整理</span>
        <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">atomic</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># 批量插入数据库</span>
                <span class="n">Regulation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>    <span class="c1"># 主动释放内存，</span>
        <span class="n">end_snapshot</span> <span class="o">=</span> <span class="n">tracemalloc</span><span class="o">.</span><span class="n">take_snapshot</span><span class="p">()</span>
        <span class="n">top_stats</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">compare_to</span><span class="p">(</span><span class="n">start_snapshot</span><span class="p">,</span> <span class="s1">&#39;lineno&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">stat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_stats</span><span class="p">[:</span><span class="mi">50</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">traceback</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">: </span><span class="si">%.1f</span><span class="s2"> KiB&quot;</span>
                  <span class="o">%</span> <span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">))</span>
</code></pre></div>


<p><img data-src="https://static.19961002.xyz/img/2022/RFK6GbLQ.png" src="https://static.19961002.xyz/img/2022/RFK6GbLQ.png" /></p>
<p><img data-src="https://static.19961002.xyz/img/2022/ewSJd0CP.png" src="https://static.19961002.xyz/img/2022/ewSJd0CP.png" /></p>
<p>发现内存主要的增长是在第一行，而且后面也主要和MySQLdb有关，那么就去看看到底是怎么回事，点开源码在发现<code>django/utils/encoding.py:62</code></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">force_str</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">strings_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;strict&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Similar to smart_str(), except that lazy instances are resolved to</span>
<span class="sd">    strings, rather than kept as lazy objects.</span>

<span class="sd">    If strings_only is True, don&#39;t convert (some) non-string-like objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Handle the common case first for performance reasons.</span>
    <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="k">if</span> <span class="n">strings_only</span> <span class="ow">and</span> <span class="n">is_protected_type</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DjangoUnicodeDecodeError</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>
</code></pre></div>


<p>虽然有注解，但还是不明所以，那最起码看看是谁在调用这个方法总也行吧</p>
<div class="codehilite"><pre><span></span><code>grep -nr <span class="s1">&#39;force_str(&#39;</span>
</code></pre></div>


<p>发现还不少调用，那就找到关键的信息继续往上追溯</p>
<p>上面那么多虽然都有调用，但是与我们实际的使用情况不符，因为使用的mysql，所以发现红线部分挺符合预期，继续查看代码<code>django/db/backends/mysql/operations.py:171</code></p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">last_executed_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="c1"># With MySQLdb, cursor objects have an (undocumented) &quot;_executed&quot;</span>
    <span class="c1"># attribute where the exact query sent to the database is saved.</span>
    <span class="c1"># See MySQLdb/cursors.py in the source distribution.</span>
    <span class="c1"># MySQLdb returns string, PyMySQL bytes.</span>
    <span class="k">return</span> <span class="n">force_str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="s1">&#39;_executed&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span>
</code></pre></div>


<p>继续查找调用改方法的地方</p>
<div class="codehilite"><pre><span></span><code>grep -nr <span class="s1">&#39;last_executed_query(&#39;</span>
</code></pre></div>


<p>找到源码<code>django./db/backends/utils.py:113</code></p>
<div class="codehilite"><pre><span></span><code><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">debug_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_last_executed_query</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">many</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">yield</span>
  <span class="k">finally</span><span class="p">:</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>
    <span class="k">if</span> <span class="n">use_last_executed_query</span><span class="p">:</span>
      <span class="n">sql</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">last_executed_query</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursor</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">times</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="n">many</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
          <span class="c1"># params could be an iterator.</span>
          <span class="n">times</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">queries_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;sql&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> times: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span> <span class="k">if</span> <span class="n">many</span> <span class="k">else</span> <span class="n">sql</span><span class="p">,</span>
            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">duration</span><span class="p">,</span>
          <span class="p">})</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;(</span><span class="si">%.3f</span><span class="s1">) </span><span class="si">%s</span><span class="s1">; args=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">duration</span><span class="p">,</span>
            <span class="n">sql</span><span class="p">,</span>
            <span class="n">params</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span> <span class="s1">&#39;sql&#39;</span><span class="p">:</span> <span class="n">sql</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">},</span>
          <span class="p">)</span>
</code></pre></div>


<p>研究一下代码发现，<code>sql = self.db.ops.last_executed_query(self.cursor, sql, params)</code>，在批量上传的时候，会将所有要上传的内容变成一条sql语句，到此为止目前还没发现有什么异常。</p>
<p>但是看到下面这一段，Django将生成的sql语句保存起来，那这个对象会清空之前保存的sql吗？</p>
<div class="codehilite"><pre><span></span><code><span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">queries_log</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;sql&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> times: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span> <span class="k">if</span> <span class="n">many</span> <span class="k">else</span> <span class="n">sql</span><span class="p">,</span>
                <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">duration</span><span class="p">,</span>
            <span class="p">})</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;(</span><span class="si">%.3f</span><span class="s1">) </span><span class="si">%s</span><span class="s1">; args=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">duration</span><span class="p">,</span>
                <span class="n">sql</span><span class="p">,</span>
                <span class="n">params</span><span class="p">,</span>
                <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span> <span class="s1">&#39;sql&#39;</span><span class="p">:</span> <span class="n">sql</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">},</span>
            <span class="p">)</span>
</code></pre></div>


<p>经过Debug发现，是不会的，每生成一条sql就添加到<code>self.db.queries_log</code>里，只要程序没有停止，那么这里边的sql就永远不会消失，所以真相大白，原来就是这个家伙导致的内存一直飙升。</p>
<p>继续向上看，寻找是否存在参数可以选择是否保存这些sql，在<code>django/db/backends/utils.py:97</code>发现这段代码</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_sql</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">use_last_executed_query</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</code></pre></div>


<p>发现确实存在一个参数<code>use_last_executed_query</code>，但是这个参数已经写死在代码里。。。</p>
<p>尝试修改源码将<code>use_last_executed_query</code>设置为False，运行代码发现问题解决。</p>
<p>后来有尝试将sql语句放入<code>self.db.queries_log</code>这段代码注释掉，运行代码仍然可以解决。</p>
<p>至此已经发现问题的真正根源出在什么地方了，但是通过修改源码的方式总归是不合适的，继续尝试有没有Django自带的方案。经过查找发现<code>django/db/__init.py:26</code></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Register an event to reset saved queries when a Django request is started.</span>
<span class="k">def</span> <span class="nf">reset_queries</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">connections</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">queries_log</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div>


<p>于是尝试在代码中引入该方法</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">reset_queries</span>

<span class="o">...</span>
<span class="c1"># 插入数据库之前首先清空</span>
<span class="n">reset_queries</span><span class="p">()</span>
<span class="c1"># 批量插入数据库</span>
<span class="n">Regulation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span>
</code></pre></div>


<p>发现问题完美的得到解决，完美！</p>
<p>后来在官方文档中发现，已经有这个方法的相关文档</p>
<p><img data-src="https://static.19961002.xyz/img/2022/dmTAMrGI.png" src="https://static.19961002.xyz/img/2022/dmTAMrGI.png" /></p>
<p>文档中还说只有在<code>DEBUG=True</code>时，这些sql语句才会保存起来以便有需要的时候查看sql。</p>
<p>这也解答了我心中的一个疑问，系统运行时产生的sql为什么要保存起来呢，现在看来是我知识浅薄了。</p>
<p>所以最终这个问题的解决方案有两个：</p>
<p>一、将<code>DEBUG</code>设置为False</p>
<p>二、手动清除，引入<code>django.db.reset_queries</code></p>
<p>就第一种方案而言，只有在生产环境下，DEBUG选项才会为False，所以在自己的电脑上或者测试机上运行，还是第二种方案比较好。</p>
    </div>





</main>

<footer>
    &copy; 2020-2022 ·
    <a href="/sitemap.xml">Sitemap</a> ·
    
    
    Powered by <a href="https://github.com/Cocojcc/zogn">zogn</a>
</footer>


</body>
</html>