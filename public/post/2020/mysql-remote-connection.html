<!doctype html>
<html lang="zh-Hans">
<head>
    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html;charset=utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="always">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="google-site-verification" content="m9HzlxEFMjeLY1dz5g98y0-93U1BVLaGlv_D4c984PI"/>
    <link rel="profile" href="http://gmpg.org/xfn/11"/>
    <link rel="canonical" href="https://2dosth.com">
    <meta property="og:locale" content="zh-Hans">

    
    <title>MySQL创建用户和配置远程连接 | Dosth</title>
    <meta name="description" content=""/>
    <meta name="keywords" content="T,e,c,h"/>
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="MySQL创建用户和配置远程连接"/>
    <meta property="og:description" content=""/>
    <meta property="og:url" content="https://2dosth.com/post/2020/mysql-remote-connection.html">
    <meta property="og:site_name" content="2dosth">
    <meta property="article:tag" content="T,e,c,h">
    <meta property="article:category" content="Tech">
    <meta property="article:published_date" content="2020-12-29">

    <link rel="canonical" href="https://2dosth.com/post/2020/mysql-remote-connection.html">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:description" content="">
    <meta name="twitter:title" content="MySQL创建用户和配置远程连接">
    <meta name="twitter:site" content="@2dosth">
    <meta name="twitter:creator" content="@2dosth">


    <link rel="stylesheet" href="/static/css/style.css" type="text/css">
    <link rel="stylesheet" href="/static/css/code.css" type="text/css">
    
        <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?c7f70ec56346e1ef095ec0104e479a46";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


    
</head>

<body data-new-gr-c-s-check-loaded="14.991.0">

<nav class="header-nav">
    <a href="/" class="site-name">Dosth</a>
    <ul class="header-links">


        <li><a href="https://twitter.com/OnePieceOwner" title="Twitter">
            <svg t="1664540582595" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 p-id="13453" width="20" height="20">
                <path d="M928 254.3c-30.6 13.2-63.9 22.7-98.2 26.4 35.4-21.1 62.3-54.4 75-94-32.7 19.5-69.7 33.8-108.2 41.2C765.4 194.6 721.1 174 672 174c-94.5 0-170.5 76.6-170.5 170.6 0 13.2 1.6 26.4 4.2 39.1-141.5-7.4-267.7-75-351.6-178.5-14.8 25.4-23.2 54.4-23.2 86.1 0 59.2 30.1 111.4 76 142.1-28-1.1-54.4-9-77.1-21.7v2.1c0 82.9 58.6 151.6 136.7 167.4-14.3 3.7-29.6 5.8-44.9 5.8-11.1 0-21.6-1.1-32.2-2.6C211 652 273.9 701.1 348.8 702.7c-58.6 45.9-132 72.9-211.7 72.9-14.3 0-27.5-0.5-41.2-2.1C171.5 822 261.2 850 357.8 850 671.4 850 843 590.2 843 364.7c0-7.4 0-14.8-0.5-22.2 33.2-24.3 62.3-54.4 85.5-88.2z"
                      p-id="13454"></path>
            </svg>
        </a></li>


        
        
        
        
        
        
        
        
        
        
        
        
        


        <li><a href="mailto:intbleem@gmail.com" title="邮件">
            <svg t="1664541082447" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 p-id="29222" width="20" height="20">
                <path d="M848 192 176 192C114.112 192 64 245.696 64 312l0 400C64 778.24 114.112 832 176 832l672 0c61.888 0 112-53.76 112-120l0-400C960 245.696 909.888 192 848 192zM885.376 332.864l-0.128 0-209.152 185.6C630.848 558.656 571.52 578.752 512.064 578.752S393.152 558.656 347.904 518.464l-209.28-185.6c0 0 45.888-35.008 92.864 0l157.248 139.584c67.968 60.416 178.56 60.416 246.592 0l157.12-139.52c46.848-34.88 92.48-0.192 92.736 0L885.376 332.864 885.376 332.864z"
                      p-id="29223" fill="#2c2c2c"></path>
            </svg>
        </a></li>

















        <li><a href="/feed.xml" title="RSS订阅">
            <svg t="1664540959387" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"
                 p-id="26382" width="20" height="20">
                <path d="M831.601 830.694c-5.591 6.057-13.046 9.318-21.433 9.318L743.54 840.012c-15.841 0-28.887-12.114-29.819-27.956-15.375-270.703-231.099-486.428-501.803-502.269-15.841-0.932-27.956-13.979-27.956-29.354l0-66.628c0-8.387 3.262-15.842 9.318-21.433 5.591-5.591 13.046-8.387 20.501-8.387 0.466 0 0.932 0 1.398 0 163.074 8.387 316.364 76.878 431.914 192.895 116.016 115.55 184.507 268.839 192.894 431.914C840.453 816.717 837.657 824.637 831.601 830.694zM593.513 830.229c-5.591 6.522-13.512 9.784-21.898 9.784l-62.901 0c-15.375 0-27.956-11.648-29.353-27.023-13.512-142.108-126.267-254.862-268.374-268.374-15.376-1.397-27.024-13.978-27.024-29.354l0-62.9c0-8.387 3.262-16.308 9.785-21.898 5.125-5.125 12.58-7.921 20.035-7.921 0.932 0 1.398 0 2.33 0 99.243 7.921 192.894 51.252 263.249 122.073 70.821 70.354 114.152 164.006 122.073 263.248C601.899 816.25 599.104 824.171 593.513 830.229zM273.42 840.013c-49.388 0-89.458-40.069-89.458-89.458s40.07-89.458 89.458-89.458 89.458 40.069 89.458 89.458S322.809 840.013 273.42 840.013z"
                      p-id="26383" fill="#2c2c2c"></path>
            </svg>
        </a></li>
    </ul>
</nav>



<main>
    
    <article class="article">
        <header class="article-header">
            <h1>MySQL创建用户和配置远程连接</h1>
            
                <p></p>
            

            <div class="article-list-footer">
                <span class="article-list-date">December 29, 2020</span>
                <span class="article-list-divider">-</span>
                <div class="article-list-category">
                    <a href="/category/Tech.html">Tech</a>
                </div>
                
                    <span class="article-list-divider">-</span>
                    <div class="article-list-tags">
                        
                            <a href="/tag/MySQL.html">MySQL</a>
                        
                            <a href="/tag/技术笔记.html">技术笔记</a>
                        
                    </div>
                
            </div>

        </header>

        <div class="article-body">
            <h2>创建远程连接用户</h2>
<p>在某些情况下，可能别人需要连接你的数据库进行操作，出于安全考虑，我们需要新建一个用户，让该用户只具有一部分的操作权限操作数据库。</p>
<p>当然如果只有你一个人使用这个数据库的话，也可以跳过这一步，直接选择root用户来操作。</p>
<p><strong>创建用户</strong></p>
<p>使用help命令查看如何创建用户</p>
<div class="codehilite"><pre><span></span><code><span class="nb">help</span> create user
</code></pre></div>


<div class="codehilite"><pre><span></span><code>Name: <span class="s1">&#39;CREATE USER&#39;</span>
Description:
Syntax:
CREATE USER user_specification
    <span class="o">[</span>, user_specification<span class="o">]</span> ...

user_specification:
    user
    <span class="o">[</span>
        IDENTIFIED BY <span class="o">[</span>PASSWORD<span class="o">]</span> <span class="s1">&#39;password&#39;</span>
      <span class="p">|</span> IDENTIFIED WITH auth_plugin <span class="o">[</span>AS <span class="s1">&#39;auth_string&#39;</span><span class="o">]</span>
    <span class="o">]</span>
</code></pre></div>


<p>根据帮助说明，接下来我们来创建用户</p>
<div class="codehilite"><pre><span></span><code>create user <span class="s1">&#39;zjc&#39;</span>@<span class="s1">&#39;localhost&#39;</span> <span class="c1"># 创建一个用户zjc，不需要密码即可登录，但只可以在本机登录</span>
create user <span class="s1">&#39;zjc&#39;</span>@<span class="s1">&#39;%&#39;</span>   <span class="c1"># 创建一个用户zjc，不需要密码即可登录，可以在任意主机登录</span>
create user <span class="s1">&#39;zjc&#39;</span>@<span class="s1">&#39;%&#39;</span> identified by <span class="s1">&#39;123456&#39;</span>    <span class="c1"># 创建一个用户zjc，登录时需要密码123456才可以登录，会自动将密码加密</span>
create user <span class="s1">&#39;zjc&#39;</span>@<span class="s1">&#39;%&#39;</span> identified by password <span class="s1">&#39;123456&#39;</span> <span class="c1"># 创建一个用户zjc，登录时需要密码123456才可以登录，会将密码明文存储</span>
</code></pre></div>


<p><strong>修改密码</strong></p>
<p>命令：</p>
<div class="codehilite"><pre><span></span><code><span class="nb">set</span> password <span class="k">for</span> <span class="s1">&#39;username&#39;</span>@<span class="s1">&#39;host&#39;</span> <span class="o">=</span> PASSWORD<span class="o">(</span><span class="s1">&#39;newpassword&#39;</span><span class="o">)</span><span class="p">;</span>
</code></pre></div>


<p>查看帮助命令查看详情</p>
<div class="codehilite"><pre><span></span><code>&gt; <span class="nb">help</span> <span class="nb">set</span> password
Name: <span class="s1">&#39;SET PASSWORD&#39;</span>
Description:
Syntax:
SET PASSWORD <span class="o">[</span>FOR user<span class="o">]</span> <span class="o">=</span>
    <span class="o">{</span>
        PASSWORD<span class="o">(</span><span class="s1">&#39;cleartext password&#39;</span><span class="o">)</span>
      <span class="p">|</span> OLD_PASSWORD<span class="o">(</span><span class="s1">&#39;cleartext password&#39;</span><span class="o">)</span>
      <span class="p">|</span> <span class="s1">&#39;encrypted password&#39;</span>
    <span class="o">}</span>
</code></pre></div>


<p>修改密码：</p>
<div class="codehilite"><pre><span></span><code><span class="nb">set</span> password <span class="k">for</span> <span class="s1">&#39;zjc&#39;</span>@<span class="s1">&#39;%&#39;</span> <span class="o">=</span> PASSWORD<span class="o">(</span><span class="s2">&quot;654321&quot;</span><span class="o">)</span>
</code></pre></div>


<p><strong>删除用户</strong></p>
<p>命令：</p>
<div class="codehilite"><pre><span></span><code>drop user username
</code></pre></div>


<h2>用户授权</h2>
<p><strong>查看用户目前的权限</strong></p>
<div class="codehilite"><pre><span></span><code>&gt; show grants <span class="k">for</span> zjc<span class="p">;</span>
+---------------------------------+
<span class="p">|</span> Grants <span class="k">for</span> zjc@%                <span class="p">|</span>
+---------------------------------+
<span class="p">|</span> GRANT USAGE ON *.* TO <span class="sb">`</span>zjc<span class="sb">`</span>@<span class="sb">`</span>%<span class="sb">`</span> <span class="p">|</span>
+---------------------------------+
</code></pre></div>


<p>USAGE相当于一个占位符，表示目前zjc用户什么权限都没有，需要我们给他授予权限</p>
<p><strong>授权该用户权限</strong></p>
<p>命令：</p>
<div class="codehilite"><pre><span></span><code>grant privileges ON databasename.tablename to <span class="s1">&#39;username&#39;</span>@<span class="s1">&#39;host&#39;</span>
</code></pre></div>


<p>同样使用help命令详情</p>
<div class="codehilite"><pre><span></span><code>&gt; <span class="nb">help</span> grant
Name: <span class="s1">&#39;GRANT&#39;</span>
Description:
Syntax:
GRANT
    priv_type <span class="o">[(</span>column_list<span class="o">)]</span>
      <span class="o">[</span>, priv_type <span class="o">[(</span>column_list<span class="o">)]]</span> ...
    ON <span class="o">[</span>object_type<span class="o">]</span> priv_level
    TO user_specification <span class="o">[</span>, user_specification<span class="o">]</span> ...
    <span class="o">[</span>REQUIRE <span class="o">{</span>NONE <span class="p">|</span> ssl_option <span class="o">[[</span>AND<span class="o">]</span> ssl_option<span class="o">]</span> ...<span class="o">}]</span>
    <span class="o">[</span>WITH with_option ...<span class="o">]</span>

GRANT PROXY ON user_specification
    TO user_specification <span class="o">[</span>, user_specification<span class="o">]</span> ...
    <span class="o">[</span>WITH GRANT OPTION<span class="o">]</span>

object_type:
    TABLE
  <span class="p">|</span> FUNCTION
  <span class="p">|</span> PROCEDURE

priv_level:
    *
  <span class="p">|</span> *.*
  <span class="p">|</span> db_name.*
  <span class="p">|</span> db_name.tbl_name
  <span class="p">|</span> tbl_name
  <span class="p">|</span> db_name.routine_name

user_specification:
    user
    <span class="o">[</span>
        IDENTIFIED BY <span class="o">[</span>PASSWORD<span class="o">]</span> <span class="s1">&#39;password&#39;</span>
      <span class="p">|</span> IDENTIFIED WITH auth_plugin <span class="o">[</span>AS <span class="s1">&#39;auth_string&#39;</span><span class="o">]</span>
    <span class="o">]</span>

ssl_option:
    SSL
  <span class="p">|</span> X509
  <span class="p">|</span> CIPHER <span class="s1">&#39;cipher&#39;</span>
  <span class="p">|</span> ISSUER <span class="s1">&#39;issuer&#39;</span>
  <span class="p">|</span> SUBJECT <span class="s1">&#39;subject&#39;</span>

with_option:
    GRANT OPTION
  <span class="p">|</span> MAX_QUERIES_PER_HOUR count
  <span class="p">|</span> MAX_UPDATES_PER_HOUR count
  <span class="p">|</span> MAX_CONNECTIONS_PER_HOUR count
  <span class="p">|</span> MAX_USER_CONNECTIONS count
</code></pre></div>


<ul>
<li>privileges：用户的操作权限，如SELECT，INSERT，UPDATE等，如果要授予所的权限则使用ALL</li>
<li>databasename：数据库名</li>
<li>tablename：表名，如果要授予该用户对所有数据库和表的相应操作权限则可用<em>表示，如</em>.*</li>
</ul>
<p>给用户zjc授予权限</p>
<div class="codehilite"><pre><span></span><code>grant all on *.* to &#39;zjc&#39;@&#39;%&#39;;  
</code></pre></div>


<p>刷新权限</p>
<div class="codehilite"><pre><span></span><code>flush privileges;
</code></pre></div>


<p><strong>取消该用户的权限</strong></p>
<p>命令：</p>
<div class="codehilite"><pre><span></span><code>revoke privilege ON databasename.tablename FROM <span class="s1">&#39;username&#39;</span>@<span class="s1">&#39;host&#39;</span><span class="p">;</span>
</code></pre></div>


<p>help查看详情</p>
<div class="codehilite"><pre><span></span><code>&gt; <span class="nb">help</span> revoke
Name: <span class="s1">&#39;REVOKE&#39;</span>
Description:
Syntax:
REVOKE
    priv_type <span class="o">[(</span>column_list<span class="o">)]</span>
      <span class="o">[</span>, priv_type <span class="o">[(</span>column_list<span class="o">)]]</span> ...
    ON <span class="o">[</span>object_type<span class="o">]</span> priv_level
    FROM user <span class="o">[</span>, user<span class="o">]</span> ...

REVOKE ALL PRIVILEGES, GRANT OPTION
    FROM user <span class="o">[</span>, user<span class="o">]</span> ...

REVOKE PROXY ON user
    FROM user <span class="o">[</span>, user<span class="o">]</span> ...
</code></pre></div>


<p>说明：同上面的授权部分</p>
<h2>配置远程链接</h2>
<p>找到配置文件中的[mysqld]一项</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># this is only for the mysqld standalone daemon</span>
<span class="o">[</span>mysqld<span class="o">]</span>

<span class="c1">#</span>
<span class="c1"># * Basic Settings</span>
<span class="c1">#</span>
<span class="nv">user</span>                    <span class="o">=</span> mysql
pid-file                <span class="o">=</span> /run/mysqld/mysqld.pid
<span class="nv">socket</span>                  <span class="o">=</span> /run/mysqld/mysqld.sock
<span class="c1">#port                   = 3306</span>
<span class="nv">basedir</span>                 <span class="o">=</span> /usr
<span class="nv">datadir</span>                 <span class="o">=</span> /var/lib/mysql
<span class="nv">tmpdir</span>                  <span class="o">=</span> /tmp
lc-messages-dir         <span class="o">=</span> /usr/share/mysql
<span class="c1">#skip-external-locking</span>
skip-name-resolve

<span class="c1"># Instead of skip-networking the default is now to listen only on</span>
<span class="c1"># localhost which is more compatible and is not less secure.</span>
<span class="c1"># bind-address            = 127.0.0.1</span>
</code></pre></div>


<p>将<strong>bind-address</strong> 注释掉,，然后重启数据库即可</p>
<div class="codehilite"><pre><span></span><code>systemctl restart mysql
</code></pre></div>


<p><strong>问题记录</strong></p>
<p>我在尝试用 navicat连接的时候，出现（2013，XXXXXXXX）的错误，这样是由于mysql在接收到客户端链接的时候需要对dns进行反向解析，由于我实在局域网内，所有反向解析是不可能成功的。</p>
<p>解决办法有两种：</p>
<ol>
<li>把client的ip写在mysql服务器的/etc/hosts文件里，随便给个名字就可以了。</li>
<li>在 my.cnf 中加入 <strong>skip-name-resolve</strong> 。</li>
</ol>
<p>于第一种方法比较笨，也不实用，那么 skip-name-resolve 选项可以禁用dns解析，但是，这样不能在mysql的授权表中使用主机名了，只能使用IP。</p>
<p>什么是mysql的dns反解析</p>
<p>mysql接收到连接请求后，获得的是客户端的ip，为了更好的匹配mysql.user里的权限记录（某些是用hostname定义的）。</p>
<p>如果mysql服务器设置了dns服务器，并且客户端ip在dns上并没有相应的hostname，那么这个过程很慢，导致连接等待。</p>
<p><strong>官方解释</strong></p>
<blockquote>
<p><em>How MySQL</em>
<em>uses DNS When a new thread connects to mysqld, mysqld will</em>
<em>spawn a new thread to handle the request. This thread will first check</em>
<em>if the hostname is in the hostname cache. If not the thread will call</em>
<em>gethostbyaddr_r() and gethostbyname_r() to resolve the hostname. If</em>
<em>the operating system doesn’t support the above thread-safe calls, the</em>
<em>thread will lock a mutex and call gethostbyaddr() and gethostbyname()</em>
<em>instead. Note that in this case no other thread can resolve other</em>
<em>hostnames that is not in the hostname cache until the first thread is</em>
<em>ready. You can disable DNS host lookup by starting mysqld with</em>
<em>–skip-name-resolve. In this case you can however only use IP names in</em>
<em>the MySQL privilege tables. If you have a very slow DNS and many</em>
<em>hosts, you can get more performance by either disabling DNS lookop</em>
<em>with –skip-name-resolve or by increasing the HOST_CACHE_SIZE define</em>
<em>(default: 128) and recompile mysqld. You can disable the hostname</em>
<em>cache with –skip-host-cache. You can clear the hostname cache with</em>
<em>FLUSH HOSTS or mysqladmin flush-hosts. If you don’t want to allow</em>
<em>connections over TCP/IP, you can do this by starting mysqld with</em>
<em>–skip-networking.</em></p>
</blockquote>
<p>根据文档说明，如果你的mysql主机查询DNS很慢或是有很多客户端主机时会导致连接很慢，由于我们的开发机器是不能够连接外网的，所以DNS解析是不可能完成的，从而也就明白了为什么连接那么慢了。同时，请注意在增加该配置参数后，mysql的授权表中的host字段就不能够使用域名而只能够使用 ip地址了，因为这是禁止了域名解析的结果。</p>
        </div>

    </article>

</main>

<footer>
    <div class="links">
        <ul>
            
                <li>
                    // <a href="http://blog.zhanghaoran.ren/">zhanghaoran.ren</a>
                </li>
            
        </ul>
    </div>
    &copy; Dosth | Theme: <a href="http://chalk.nielsenramon.com">Chalk</a>
    
    
    
    
</footer>


</body>
</html>